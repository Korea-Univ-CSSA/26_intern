// components/VulnerabilityCharts.js
import React, { useMemo, useState } from "react";
import { Box, Stack, Typography, Chip, Fade } from "@mui/material";
import {
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";
import CweDistributionBox from "./CweDistributionBox";
import SunburstChart from "../new_utils/Sunburst/SunburstChart";
import COLOR_POOL from "../new_utils/color_pool";

/* =====================
   CVSS 색상
===================== */
const SEVERITY_COLORS = {
  Critical: "#7b1fa2",
  High: "#d32f2f",
  Medium: "#fbc02d",
  Low: "#388e3c",
  Unknown: "#9e9e9e", // ✅ 회색
};

const SEVERITY_ORDER = ["Critical", "High", "Medium", "Low", "Unknown"];

/* =====================
   CVSS → Severity
===================== */
const getSeverity = (cvssStr) => {
  if (cvssStr === undefined || cvssStr === null) return "Unknown";

  const score = Number(cvssStr);
  if (Number.isNaN(score) || score <= 0) return "Unknown";

  if (score < 4.0) return "Low";
  if (score < 7.0) return "Medium";
  if (score < 9.0) return "High";
  return "Critical";
};

/* =====================
   Pie label (% 정수)
===================== */
const renderPercentLabel = ({ percent }) => `${Math.round(percent * 100)}%`;

/* =====================
   Tooltip (CVE 목록 + 개수)
===================== */
const CustomTooltip = ({ active, payload }) => {
  if (active && payload?.length) {
    const { name, payload: data } = payload[0];

    return (
      <Box
        sx={{
          p: 1.5,
          backgroundColor: "#222",
          color: "#fff",
          borderRadius: 1,
          fontSize: 12,
          maxWidth: 320,
        }}
      >
        <Typography fontWeight="bold">{name}</Typography>
        <Typography variant="caption">Count: {data.value}</Typography>

        <Box sx={{ mt: 1, fontSize: 11, lineHeight: 1.4 }}>
          {data.cves.join(", ") || "N/A"}
        </Box>
      </Box>
    );
  }
  return null;
};

const VulnerabilityCharts = ({ response }) => {
  const rawData = response?.raw_data || [];
  const cveDb = response?.cve_db || [];

  const [layout, setLayout] = useState("Individual");
  const options = ["Individual", "Sunburst"];

  /* =====================
     CVE → CVSS 매핑
  ===================== */
  const cveCvssMap = useMemo(() => {
    const map = {};

    cveDb.forEach(({ name, cvss }) => {
      map[name] = cvss;
    });

    return map;
  }, [cveDb]);

  /* =====================
     CVSS Severity Pie 데이터
  ===================== */
  const pieCvssData = useMemo(() => {
    const buckets = {
      Critical: [],
      High: [],
      Medium: [],
      Low: [],
      Unknown: [],
    };

    rawData.forEach(({ cveid }) => {
      const severity = getSeverity(cveCvssMap[cveid]);

      if (!buckets[severity].includes(cveid)) {
        buckets[severity].push(cveid);
      }
    });

    return SEVERITY_ORDER.map((key) => ({
      name: key,
      value: buckets[key].length,
      cves: buckets[key],
    }));
  }, [rawData, cveCvssMap]);

  const pieCweData = useMemo(() => {
    const data = response?.result_json?.pie_cwe_json || [];

    return data.map((item, idx) => ({
      ...item,
      fill: `hsl(${(idx * 137.508) % 360}, 65%, 55%)`, // ✅ 겹치지 않는 색
    }));
  }, [response]);

  return (
    <>
    {/* Newly added */}
      <Stack direction="row" spacing={1}>
        {options.map((option) => (
          <Chip
            key={option}
            label={option}
            clickable
            variant={layout === option ? "filled" : "outlined"}
            onClick={() => setLayout(option)}
            sx={{
              bgcolor: layout === option ? COLOR_POOL.main[0] : undefined,
              color: layout === option ? "#fff" : undefined,
              "&:hover": {
                bgcolor: layout === option ? COLOR_POOL.main[1] : undefined,
              },
              margin: "5px",
            }}
          />
        ))}
      </Stack>

      <Fade
        in={layout === "Individual"}
        timeout={200}
        mountOnEnter
        unmountOnExit
      >
        <Box>
          {/* =====================
          Bar Chart (연도별 CVE)
        ===================== */}
          <Box
            sx={{
              my: 4,
              p: 2,
              borderRadius: 2,
              boxShadow: 3,
            }}
          >
            <Typography variant="h6" sx={{ mb: 1 }}>
              CVE Trend by Year
            </Typography>

            <Box sx={{ width: "100%", height: 400 }}>
              <ResponsiveContainer>
                <BarChart data={response?.result_json?.bar_json || []}>
                  <XAxis dataKey="x" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="num" fill="#8884d8" name="CVEs per year" />
                </BarChart>
              </ResponsiveContainer>
            </Box>
          </Box>

          {/* =====================
          Pie Charts Section
        ===================== */}
          <Stack
            direction={{ xs: "column", md: "row" }}
            spacing={4}
            sx={{ mt: 4 }}
          >
            {/* ✅ CVSS Pie */}
            <Box
              sx={{
                flex: 1,
                p: 2,
                borderRadius: 2,
                boxShadow: 3,
              }}
            >
              <Typography variant="h6" sx={{ mb: 1 }}>
                CVSS Severity Distribution
              </Typography>

              <Box sx={{ width: "100%", height: 420 }}>
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieCvssData}
                      dataKey="value"
                      nameKey="name"
                      outerRadius={160}
                      label={renderPercentLabel}
                    >
                      {pieCvssData.map((entry) => (
                        <Cell
                          key={entry.name}
                          fill={SEVERITY_COLORS[entry.name]}
                        />
                      ))}
                    </Pie>
                    <Tooltip content={<CustomTooltip />} />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              </Box>
            </Box>

            {/* ✅ CWE Pie */}
            <CweDistributionBox pieCweData={pieCweData} />
          </Stack>
        </Box>
      </Fade>

      {/* =====================
          NEWLY ADDED
        ===================== */}
      <Fade in={layout === "Sunburst"} timeout={200}>
        <Box>
          <SunburstChart cvssData={pieCvssData} pieCweData={pieCweData} />
        </Box>
      </Fade>
    </>
  );
};

export default VulnerabilityCharts;
